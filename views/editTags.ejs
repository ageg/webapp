<div class="row">
  <div class="col-md-10 vcenter">
    <h2>Edit Tags</h2>
  </div>
  <button type="button" class="btn btn-default col-md-1 vcenter" aria-label="Add Tag" onclick="addTag()">
    <span class="glyphicon glyphicon-plus" aria-hidden="true" style="color:green"></span> Add Tag
  </button>
</div>
<div id="tags">
</div>

<script type="text/x-jsrender" id="template-tag">
  <div class="row content-box" id="{{:_id}}">
    <div class="col-md-8 vcenter">
      <h4>{{:name}}</h4>
    </div>
    <button type="button" class="btn btn-default" aria-label="Edit Tag Type" onclick="editTags('{{:_id}}')" style="margin-right:8px;">
      <span class="glyphicon glyphicon-open" aria-hidden="true"></span> Edit Type
    </button>
    <button type="button" class="btn btn-default" aria-label="Edit Tags" onclick="editEditions('{{:_id}}')" style="margin-right:8px;">
      <span class="glyphicon glyphicon-edit" aria-hidden="true" style="color:blue"></span> Edit Tags
    </button>
    <button type="button" class="btn btn-default" aria-label="Delete Tag Type" onclick="removeTags('{{:_id}}')" style="margin-right:8px;">
      <span class="glyphicon glyphicon-remove" aria-hidden="true" style="color:red"></span> Delete Type
    </button>
  </div>
</script>

<script type="text/x-jsrender" id="template-edit-tag">
  <div class="form-group">
    <label for="name">Name:</label>
    <input type="text" class="form-control" id="{{:_id}}.name" name="name" value="{{:name}}">
  </div>
  <div class="form-group">
    <label for="price">Default Price:</label>
    <input type="number" class="form-control" id="{{:_id}}.price" name="price" value="{{:price}}">
  </div>
  <div class="row">
    <div class="col-md-2"></div>
    <button type="button" class="btn btn-default col-md-2" aria-label="Save Tag" onclick="saveTag('{{:_id}}')" style="margin-right:8px;">
      <span class="glyphicon glyphicon-save" aria-hidden="true" style="color:blue"></span> Save
    </button>
    <div class="col-md-2"></div>
    <div class="col-md-2"></div>
    <button type="button" class="btn btn-default col-md-2" aria-label="Cancel Tag" onclick="cancelTag('{{:_id}}')" style="margin-right:8px;">
      <span class="glyphicon glyphicon-ban-circle" aria-hidden="true" style="color:red"></span> Cancel
    </button>
  </div>
</script>

  <script>
  var tagsList = <%- tags %>;

  $(document).ready(renderTags);
  
  function renderTags(){
    var template = $.templates("#template-tag");
    var htmlOutput = template.render(tagsList);
    $('#tags').html(htmlOutput);
  };
  
  function addTag(){
    $.ajax({
        url : window.location.href,
        type: "POST",
        data : '',
        success: function(tag)
        {
          console.log(tag);
          tag = JSON.parse(tag);
          tagsList.push(tag);
          renderTags();
        },
        error: function (err)
        {
          console.log(err);
        }
    });
  }
  
  function removeTag(id){
  var resp = confirm('Are you sure you want to delete?');
    if (resp) {
      $.ajax({
        url : window.location.href,
        type: "DELETE",
        contentType: "application/json; charset=utf-8",
        data : JSON.stringify({"_id": id}),
        success: function(_id)
        {
          $("#"+_id).remove();
          tagsList = _.without(typesList, _.findWhere(tagsList, {_id: id}));
        },
        error: function (err)
        {
          console.log(err);
        }
      });
    }
  }
  
  function editTag(id) {
    var template = $.templates("#template-edit-type");
    var htmlOutput = template.render(_.findWhere(typesList, {_id: id}));
    $("#"+id).html(htmlOutput);
  }
  
  function cancelTag(id) {
    var template = $.templates("#template-type");
    var htmlOutput = template.render(_.findWhere(typesList, {_id: id}));
    $("#"+id).replaceWith(htmlOutput);
  }
  
  function saveTag(id) {
    var newType = {_id: id, name: $("#" + id + "\\.name").val(), price: $("#" + id + "\\.price").val(), pricedescription: $("#" + id + "\\.pricedescription").val()};
    console.log(JSON.stringify(newType));
    $.ajax({
      url : window.location.href,
      type: "PUT",
      contentType: "application/json; charset=utf-8",
      data : JSON.stringify(newType),
      success: function(type)
      {
        type = JSON.parse(type);
        var match = _.where(typesList , {_id: id});
        match[0].name = type.name;
        match[0].price = type.price;
        match[0].pricedescription = type.pricedescription;
        var template = $.templates("#template-type");
        var htmlOutput = template.render(type);
        $("#"+id).replaceWith(htmlOutput);
      },
        error: function (err)
      {
        console.log(err);
      }
    });
  }
</script>